<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - ID and Product Image Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary: #2B1F6F; --primary-hover: #232526; --secondary: #414345;
      --container-bg: rgba(255,255,255,0.98); --shadow: 0 8px 48px rgba(43,31,111,0.20);
      --border-radius: 16px; --border-radius-small: 8px; --input-bg: #f4f6fa;
      --input-border: #bfc1cc; --label-color: #2B1F6F; --note-color: #888;
      --color-bg-gradient: linear-gradient(135deg, #2B1F6F 0%, #232526 60%, #414345 100%);
    }
    html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--color-bg-gradient); background-attachment: fixed; margin: 0; padding: 0; }
    .container { max-width: 1100px; min-width: 350px; margin: 64px auto 48px auto;
      background: var(--container-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
      padding: 3.5em 4em 2.5em 4em; box-sizing: border-box; backdrop-filter: blur(2px);
      display: flex; flex-direction: row; gap: 3em; justify-content: center; }
    .panel { flex: 1 1 0; min-width: 0; max-width: 480px; display: flex; flex-direction: column; }
    h2 { margin-top: 0; color: var(--primary); font-size: 2em; letter-spacing: 0.02em;
      text-shadow: 0 2px 8px rgba(43,31,111,0.06); margin-bottom: 0.25em; }
    .section { margin-bottom: 2.5em; border-bottom: 1px solid #e0e0e0; padding-bottom: 2em; }
    label { display: block; margin: 1em 0 0.5em 0; font-weight: bold; color: var(--label-color);
      font-size: 1.05em; letter-spacing: .01em; }
    input[type="text"] { width: 100%; padding: 1.1em 1em; font-size: 1.18em;
      border: 1.5px solid var(--input-border); border-radius: var(--border-radius-small); margin-bottom: 0;
      box-sizing: border-box; background: var(--input-bg); transition: border 0.2s, box-shadow 0.2s;
      font-family: 'Segoe UI', Arial, sans-serif; min-width: 0; }
    input[type="file"] { margin-bottom: 1em; font-size: 1em; }
    input[type="text"]:focus, textarea:focus { border: 2px solid var(--primary); outline: none; background: #fff;
      box-shadow: 0 0 0 3px #2b1f6f22; }
    img { display: block; max-width: 100%; max-height: 280px; margin: 1em 0 0.7em 0;
      border-radius: var(--border-radius-small); box-shadow: 0 2px 12px rgba(43,31,111,0.11);
      object-fit: contain; background: #eee; border: 1.5px solid #e1e1ef; }
    button { padding: 1em 0; background: var(--primary); color: #fff; border: none;
      border-radius: var(--border-radius-small); font-size: 1.17em; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s; margin-top: 0.5em; margin-bottom: 1em; width: 100%;
      box-sizing: border-box; box-shadow: 0 2px 16px rgba(43,31,111,0.10); font-weight: 600;
      letter-spacing: 0.04em; }
    button:hover, button:focus { background: var(--secondary); box-shadow: 0 4px 20px rgba(35,37,38,0.17); }
    .note { color: var(--note-color); font-size: 1em; margin-bottom: 1em; }
    .account-input-row { display: flex; align-items: flex-end; gap: 1em; margin-bottom: 2.5em; margin-top: -1.5em;
      flex-wrap: wrap; }
    .account-input-row label { margin: 0 0 0.5em 0; flex-basis: 100%; }
    .account-input-row input[type="text"] { margin-bottom: 0; flex: 3 1 220px; font-size: 1.3em; padding: 1.1em 1em;
      border-radius: var(--border-radius-small); min-width: 0; }
    .account-input-row button { width: auto; padding: 1.1em 2.5em; font-size: 1.15em; margin: 0; margin-bottom: 0.1em;
      border-radius: var(--border-radius-small); box-shadow: 0 2px 8px rgba(43,31,111,0.10); min-width: 110px; flex: 0 0 auto; }
    .product-info { background: #f3f5fa; border-radius: var(--border-radius-small); padding: 1.3em 1em 1em 1em;
      margin-bottom: 1.5em; margin-top: 0.3em; box-shadow: 0 2px 8px 0 #2b1f6f10; border: 1px solid #e6e8f0; }
    .product-info-row { display: flex; align-items: center; margin-bottom: 0.6em; font-size: 1.07em; }
    .product-info-label { width: 130px; color: var(--primary); font-weight: 500; margin-right: 0.4em; flex-shrink: 0; }
    .product-info-value { color: #222; font-weight: 600; letter-spacing: 0.03em; word-break: break-all; }
    textarea { width: 100%; min-width: 0; font-size: 1.09em; padding: 1em 1.2em; border: 1.5px solid var(--input-border);
      border-radius: var(--border-radius-small); box-sizing: border-box; background: var(--input-bg); resize: vertical;
      margin-bottom: 1.2em; min-height: 140px; max-height: 260px; line-height: 1.48em; max-width: 100%;
      overflow-y: auto; overflow-x: auto; box-shadow: 0 1px 7px #2b1f6f08; }
    details { color: #444; font-size: 0.94em; margin-top: 0.8em; }
    summary { cursor: pointer; color: #2B1F6F; }
    .section-title { font-size: 1.3em; color: #2B1F6F; margin: 2em 0 1em 0; font-weight: bold; }
    .product-list-section { background: #f8fafd; border-radius: 10px; padding: 1.2em 1em 1.5em 1em; margin-bottom: 2em; box-shadow: 0 2px 8px #2b1f6f10; }
    .add-product-section { background: #f8fafd; border-radius: 10px; padding: 1.2em 1em 1.5em 1em; margin-bottom: 2em; box-shadow: 0 2px 8px #2b1f6f10; }
    @media (max-width: 1250px) { .container { max-width: 98vw; gap: 1.2em; padding: 2em 1.2em 1.5em 1.2em; }
      .panel { max-width: 600px; } }
    @media (max-width: 900px) { .container { flex-direction: column; gap: 2.5em; padding: 2.2em 1.5em 1.2em 1.5em; }
      .panel { max-width: 100vw; } }
    @media (max-width: 700px) { .container { padding: 0.8em 0.2em 0.2em 0.2em; border-radius: 0; box-shadow: none; min-width: 0; }
      .section { padding-bottom: 1em; margin-bottom: 1em; } h2 { font-size: 1.2em; }
      img { max-height: 100px; } button, .account-input-row button { font-size: 1em !important; padding: 0.7em 0.8em !important; }
      label, .note { font-size: 0.98em; } textarea, input[type="text"], .account-input-row input[type="text"] {
        font-size: 0.98em !important; padding: 0.7em 0.6em !important; min-width: 0; }
      .product-info-label { width: 90px; font-size: 0.97em; } .account-input-row { gap: 0.5em; } }
    @media (max-width: 480px) { .container { padding: 0.2em 0.05em; } .product-info-label { width: 72px; } }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <!-- Left Panel: ID Verification -->
    <div class="panel">
      <h2>ID Verification</h2>
      <div class="section">
        <label for="idImage">Upload ID Image</label>
        <input type="file" id="idImage" accept="image/*">
        <img id="idPreview" style="display:none;" alt="ID Preview" />
        <div class="note">
          After uploading, the extracted information will appear below.<br>
          <b>Detected Card Type:</b> <span id="cardTypeDisplay">---</span>
        </div>
        <label for="extractedText">Extracted Info (Review & Edit)</label>
        <textarea id="extractedText" rows="10" placeholder="Extracted info will appear here..."></textarea>
        <details id="rawOCRDetails" style="display:none;">
          <summary>Show Raw OCR Output</summary>
          <pre id="rawOCR"></pre>
        </details>
        <button id="verifyBtn">Verify Account</button>
      </div>
    </div>
    <!-- Right Panel: Account/Products -->
    <div class="panel">
      <!-- Account Number Input always at top -->
      <div class="account-input-row">
        <label for="accountNumberTop">Enter Account Number</label>
        <input type="text" id="accountNumberTop" placeholder="Account number">
        <button id="accountNumberEnterBtn" type="button">Enter</button>
      </div>
      <!-- Product Info (basic) -->
      <div class="product-info" id="productInfoBox">
        <div class="product-info-row">
          <span class="product-info-label">Account Number:</span>
          <span class="product-info-value" id="productAccountNumber">---</span>
        </div>
        <div class="product-info-row">
          <span class="product-info-label">User's Name:</span>
          <span class="product-info-value" id="userNameDisplay">---</span>
        </div>
      </div>
      <!-- All Products Section -->
      <div class="product-list-section">
        <div class="section-title">All Products for This Account</div>
        <div id="allProductsList" style="margin-top:1em;"></div>
      </div>
      <!-- Add New Product Section -->
      <div class="add-product-section">
        <div class="section-title">Add New Product</div>
        <label for="productNameInput">Product Name</label>
        <input type="text" id="productNameInput" placeholder="Enter product name">
        <label for="productDescInput">Product Description</label>
        <input type="text" id="productDescInput" placeholder="Enter product description">
        <label for="productCategoryInput">Category</label>
        <input type="text" id="productCategoryInput" placeholder="Enter product category">
        <label for="productSubcategoryInput">Subcategory</label>
        <input type="text" id="productSubcategoryInput" placeholder="Enter product subcategory">
        <label for="productImage">Upload Product Image</label>
        <input type="file" id="productImage" accept="image/*">
        <img id="productPreview" style="display:none;" alt="Product Preview" />
        <button id="submitProductBtn" type="button">Submit Product</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Firebase Init
    const firebaseConfig = {
      apiKey: "AIzaSyDZsj-cL_T_BuLtAz5bkqsw-edZXnumwe0",
      authDomain: "iot-web-58054.firebaseapp.com",
      databaseURL: "https://iot-web-58054-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iot-web-58054",
      storageBucket: "iot-web-58054.appspot.com",
      messagingSenderId: "949884902967",
      appId: "1:949884902967:web:6e7f78c7cd0fa1484629b2",
      measurementId: "G-5C79490N66"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Minimal extractIdFields for brevity
    function extractIdFields(text) {
      return { summary: text, cardType: 'Unknown' };
    }

    document.getElementById('idImage').addEventListener('change', function(e) {
      const img = document.getElementById('idPreview');
      const file = e.target.files[0];
      const cardTypeDisplay = document.getElementById('cardTypeDisplay');
      const extractedTextArea = document.getElementById('extractedText');
      const rawOCR = document.getElementById('rawOCR');
      const rawOCRDetails = document.getElementById('rawOCRDetails');
      cardTypeDisplay.textContent = 'Processing...';
      extractedTextArea.value = 'Extracting... Please wait.';
      rawOCRDetails.style.display = "none";
      if (file) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
        const reader = new FileReader();
        reader.onload = function(ev) {
          Tesseract.recognize(
            ev.target.result,
            'eng',
            {
              workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
              langPath: 'https://tessdata.projectnaptha.com/4.0.0_best'
            }
          ).then(({ data: { text } }) => {
            const { summary, cardType } = extractIdFields(text || '');
            extractedTextArea.value = summary;
            cardTypeDisplay.textContent = cardType;
            rawOCR.textContent = text || '';
            rawOCRDetails.style.display = "";
          }).catch(err => {
            extractedTextArea.value = 'OCR Error: ' + err.message;
            cardTypeDisplay.textContent = 'Error';
            rawOCRDetails.style.display = "none";
          });
        };
        reader.readAsDataURL(file);
      } else {
        img.style.display = 'none';
        extractedTextArea.value = "";
        cardTypeDisplay.textContent = "---";
        rawOCRDetails.style.display = "none";
      }
    });

    document.getElementById('productImage').addEventListener('change', function(e) {
      const img = document.getElementById('productPreview');
      const file = e.target.files[0];
      if (file) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
    });

    function renderAllProducts(acctNum) {
      const listDiv = document.getElementById('allProductsList');
      listDiv.innerHTML = "Loading...";
      if (!acctNum) { listDiv.innerHTML = ""; return; }
      database.ref('products/' + acctNum).once('value', function(snapshot) {
        if (snapshot.exists()) {
          const products = snapshot.val();
          let html = `<ul style="padding-left:1.2em;">`;
          Object.entries(products).forEach(([prodId, prod]) => {
            html += `<li>
              <b>${prod.productName || "(No Name)"}:</b> ${prod.productDesc || ""}<br>
              <b>Category:</b> ${prod.productCategory || ""} <b>Subcategory:</b> ${prod.productSubcategory || ""}<br>
              ${prod.imageUrl ? `<img src="${prod.imageUrl}" style="max-width:120px;max-height:90px;border-radius:8px;border:1px solid #ccc;">` : ""}
              <br><small>Added: ${prod.addedAt ? new Date(prod.addedAt).toLocaleString() : ""}</small>
            </li><hr>`;
          });
          html += `</ul>`;
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = "<i>No products for this account.</i>";
        }
      });
    }

    document.getElementById('accountNumberEnterBtn').onclick = function() {
      var acct = document.getElementById('accountNumberTop').value.trim();
      document.getElementById('productAccountNumber').textContent = acct ? acct : "---";
      renderAllProducts(acct);
      if (!acct) {
        document.getElementById('userNameDisplay').textContent = "---";
        document.getElementById('productNameInput').value = "";
        document.getElementById('productDescInput').value = "";
        document.getElementById('productCategoryInput').value = "";
        document.getElementById('productSubcategoryInput').value = "";
        return;
      }
      database.ref('users').orderByChild('accountNumber').equalTo(acct).once('value', function(snapshot) {
        if (snapshot.exists()) {
          const userObj = Object.values(snapshot.val())[0];
          document.getElementById('userNameDisplay').textContent = userObj.name || "---";
        } else {
          document.getElementById('userNameDisplay').textContent = "---";
        }
        // Clear add product fields for new account lookup
        document.getElementById('productNameInput').value = "";
        document.getElementById('productDescInput').value = "";
        document.getElementById('productCategoryInput').value = "";
        document.getElementById('productSubcategoryInput').value = "";
        document.getElementById('productImage').value = "";
        document.getElementById('productPreview').style.display = "none";
      });
    };

    document.getElementById('submitProductBtn').onclick = function() {
      const acctNum = document.getElementById('productAccountNumber').textContent.trim();
      const productName = document.getElementById('productNameInput').value.trim();
      const productDesc = document.getElementById('productDescInput').value.trim();
      const productCategory = document.getElementById('productCategoryInput').value.trim();
      const productSubcategory = document.getElementById('productSubcategoryInput').value.trim();
      const userName = document.getElementById('userNameDisplay').textContent.trim();
      const imageInput = document.getElementById('productImage');
      const imageFile = imageInput.files[0];

      if (!acctNum || acctNum === "---") {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Number',
          text: 'Please enter a valid account number and press Enter first.',
          confirmButtonColor: '#e53935'
        });
        return;
      }
      if (!productName) {
        Swal.fire({
          icon: 'warning',
          title: 'Missing Product Name',
          text: 'Please enter the product name.',
          confirmButtonColor: '#2196f3'
        });
        return;
      }

      database.ref('users').orderByChild('accountNumber').equalTo(acctNum).once('value', function(snapshot) {
        if (!snapshot.exists()) {
          Swal.fire({
            icon: 'error',
            title: 'Account Not Found',
            text: 'No user found with that account number.',
            confirmButtonColor: '#e53935'
          });
          return;
        }
        const userId = Object.keys(snapshot.val())[0];
        function saveProduct(imageUrl, imageName) {
          const newProductRef = database.ref('products/' + acctNum).push();
          newProductRef.set({
            productName: productName,
            productDesc: productDesc,
            productCategory: productCategory,
            productSubcategory: productSubcategory,
            imageName: imageName || "",
            imageUrl: imageUrl || "",
            userId: userId,
            userName: userName,
            addedAt: new Date().toISOString()
          }).then(() => {
            database.ref('users/' + userId).update({
              productDesc: productDesc,
              latestProductImageName: imageName || "",
              latestProductImageUrl: imageUrl || "",
              product: productName,
              mainCategory: productCategory,
              subcategory: productSubcategory
            });
            Swal.fire({
              icon: 'success',
              title: 'Product Added!',
              text: 'Product has been added for this account.',
              confirmButtonColor: '#2196f3'
            });
            // Clear add form, update list
            document.getElementById('productNameInput').value = '';
            document.getElementById('productDescInput').value = '';
            document.getElementById('productCategoryInput').value = '';
            document.getElementById('productSubcategoryInput').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productPreview').style.display = 'none';
            renderAllProducts(acctNum);
          }).catch((error) => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: error.message,
              confirmButtonColor: '#e53935'
            });
          });
        }
        if (imageFile) {
          Swal.fire({
            title: 'Uploading...',
            text: 'Please wait while we upload your image.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          const imageName = Date.now() + "_" + imageFile.name.replace(/\s+/g, "_");
          const storageRef = storage.ref('product_images/' + acctNum + '/' + imageName);
          storageRef.put(imageFile).then(snapshot => {
            snapshot.ref.getDownloadURL().then(imageUrl => {
              Swal.close();
              saveProduct(imageUrl, imageName);
            });
          }).catch(err => {
            Swal.fire({
              icon: 'error',
              title: 'Image Upload Failed',
              text: err.message,
              confirmButtonColor: '#e53935'
            });
          });
        } else {
          saveProduct();
        }
      });
    };

    document.getElementById('verifyBtn').onclick = function() {
      var acct = document.getElementById('accountNumberTop').value.trim();
      if (!acct) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Number',
          text: 'Please enter the account number in the Product Panel first!',
          confirmButtonColor: '#e53935'
        });
        return;
      }
      Swal.fire({
        title: 'Verifying...',
        text: 'Please wait while we verify the account.',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      database.ref('users').orderByChild('accountNumber').equalTo(acct).once('value', function(snapshot) {
        if (snapshot.exists()) {
          const userId = Object.keys(snapshot.val())[0];
          database.ref('users/' + userId).update({ verified: true })
            .then(() => {
              Swal.fire({
                icon: 'success',
                title: 'Account Verified!',
                text: 'The user account has been marked as verified.',
                confirmButtonColor: '#2196f3'
              });
            })
            .catch((error) => {
              Swal.fire({
                icon: 'error',
                title: 'Verification Failed',
                text: error.message,
                confirmButtonColor: '#e53935'
              });
            });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Account Not Found',
            text: 'No user found for this account number.',
            confirmButtonColor: '#e53935'
          });
        }
      }, function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message,
          confirmButtonColor: '#e53935'
        });
      });
    };
  </script>
</body>
</html>