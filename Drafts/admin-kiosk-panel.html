<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Generator & Print</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary: #2B1F6F; --primary-hover: #232526; --secondary: #414345;
      --container-bg: rgba(255,255,255,0.98); --shadow: 0 8px 48px rgba(43,31,111,0.20);
      --border-radius: 16px; --border-radius-small: 8px; --input-bg: #f4f6fa;
      --input-border: #bfc1cc; --label-color: #2B1F6F; --note-color: #888;
      --color-bg-gradient: linear-gradient(135deg, #2B1F6F 0%, #232526 60%, #414345 100%);
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">

    <!-- Left Panel: ID Verification -->
    <div class="panel">
      <h2>ID Verification</h2>
      <div class="section">
        <label for="idImage">Upload ID Image</label>
        <input type="file" id="idImage" accept="image/*">
        <img id="idPreview" style="display:none;" alt="ID Preview" />
        <div class="note">
          After uploading, the extracted information will appear below. You can review and edit it before verifying the account.<br>
          <b>Detected Card Type:</b> <span id="cardTypeDisplay">---</span>
        </div>
        <label for="extractedText">Extracted Info (Review & Edit)</label>
        <textarea id="extractedText" rows="10" placeholder="Extracted info will appear here..."></textarea>
        <details id="rawOCRDetails" style="display:none;">
          <summary>Show Raw OCR Output</summary>
          <pre id="rawOCR"></pre>
        </details>
        <button id="verifyBtn">Verify Account</button>
      </div>
    </div>

    <!-- Right Panel: Product Image Upload -->
    <div class="panel">
      <!-- Account Number Input -->
      <div class="account-input-row">
        <label for="accountNumberTop">Enter Account Number</label>
        <input type="text" id="accountNumberTop" placeholder="Account number">
        <button id="accountNumberEnterBtn" type="button">Enter</button>
      </div>
      <h2>Product Image Upload</h2>
      <div class="section" style="border-bottom: none; padding-bottom:0;">
        <div class="product-info" id="productInfoBox">
          <div class="product-info-row">
            <span class="product-info-label">Account Number:</span>
            <span class="product-info-value" id="productAccountNumber">---</span>
          </div>
          <div class="product-info-row">
            <span class="product-info-label">Product Name:</span>
            <span class="product-info-value" id="productNameDisplay">---</span>
          </div>
          <div class="product-info-row">
            <span class="product-info-label">User's Name:</span>
            <span class="product-info-value" id="userNameDisplay">---</span>
          </div>
        </div>
        <label for="productNameInput">Product Name</label>
        <input type="text" id="productNameInput" placeholder="Enter product name">
        <label for="productDescInput">Product Description</label>
        <input type="text" id="productDescInput" placeholder="Enter product description">
        <label for="productImage">Upload Product Image</label>
        <input type="file" id="productImage" accept="image/*">
        <img id="productPreview" style="display:none;" alt="Product Preview" />
        <button id="submitProductBtn" type="button">Submit Product</button>
      </div>
    </div>
    <div id="qrcode"></div>
    <button id="printBtn" type="button">Print</button>
  </div>
  <script>
    // Firebase Init
    const firebaseConfig = {
      apiKey: "AIzaSyDZsj-cL_T_BuLtAz5bkqsw-edZXnumwe0",
      authDomain: "iot-web-58054.firebaseapp.com",
      databaseURL: "https://iot-web-58054-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iot-web-58054",
      storageBucket: "iot-web-58054.appspot.com",
      messagingSenderId: "949884902967",
      appId: "1:949884902967:web:6e7f78c7cd0fa1484629b2",
      measurementId: "G-5C79490N66"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();
    const storage = firebase.storage();

    // OCR extractIdFields helper (unchanged)
    function extractIdFields(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
      let info = {
        name: '', dob: '', id: '', address: '',
        sex: '', nationality: '', issued: '', expiry: '', cardType: 'Unknown'
      };
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        if (!info.name && /(name|cardholder|holder)/i.test(line) && /[A-Z][A-Z\s\-']+/.test(line)) {
          info.name = line.replace(/.*(name|cardholder|holder)[:\-]?\s*/i, '').trim();
        }
        if (!info.name && /^[A-Z][A-Z\s\-']+$/.test(line) && line.split(' ').length >= 2 &&
            !/(DATE|SEX|ID|ADDRESS|NATION|ISSUED|EXPIRATION)/i.test(line)) {
          info.name = line;
        }
        if (!info.dob && /(date of birth|birth date|dob)[:\-]?\s*(.+)/i.test(line)) {
          info.dob = line.match(/(date of birth|birth date|dob)[:\-]?\s*(.+)/i)[2].trim();
        }
        if (!info.id && /(id number|id no|id #|id:)[:\-]?\s*([A-Z0-9\-]+)/i.test(line)) {
          info.id = line.match(/(id number|id no|id #|id:)[:\-]?\s*([A-Z0-9\-]+)/i)[2].trim();
        }
        if (!info.address && /(address)[:\-]?\s*(.+)/i.test(line)) {
          info.address = line.match(/(address)[:\-]?\s*(.+)/i)[2].trim();
        }
        if (!info.sex && /(sex|gender)[:\-]?\s*(male|female|m|f)/i.test(line)) {
          info.sex = line.match(/(sex|gender)[:\-]?\s*(male|female|m|f)/i)[2].toUpperCase();
        }
        if (!info.nationality && /(nationality|citizen(ship)?)[:\-]?\s*([A-Za-z ]+)/i.test(line)) {
          info.nationality = line.match(/(nationality|citizen(ship)?)[:\-]?\s*([A-Za-z ]+)/i)[3].toUpperCase();
        }
        if (!info.issued && /(issued date|date issued|date of issue)[:\-]?\s*(.+)/i.test(line)) {
          info.issued = line.match(/(issued date|date issued|date of issue)[:\-]?\s*(.+)/i)[2].trim();
        }
        if (!info.expiry && /(expiration date|expiry date|valid until|exp date)[:\-]?\s*(.+)/i.test(line)) {
          info.expiry = line.match(/(expiration date|expiry date|valid until|exp date)[:\-]?\s*(.+)/i)[2].trim();
        }
      }
      let nameIdx = -1;
      for (let i = 0; i < lines.length; i++) {
        if (info.name && lines[i].toUpperCase() === info.name.toUpperCase()) {
          nameIdx = i;
          break;
        }
      }
      if (nameIdx !== -1) {
        if (!info.dob && lines[nameIdx + 1]) info.dob = lines[nameIdx + 1];
        if (!info.id && lines[nameIdx + 2]) info.id = lines[nameIdx + 2];
        if (!info.address && lines[nameIdx + 3]) info.address = lines[nameIdx + 3];
      }
      const joined = text.toLowerCase();
      if (joined.includes('philsys') || joined.includes('republic of the philippines')) info.cardType = 'Philippine National ID';
      else if (joined.includes('driver')) info.cardType = 'Driver\'s License';
      else if (joined.includes('passport')) info.cardType = 'Passport';
      else if (joined.includes('student') && joined.includes('id')) info.cardType = 'Student ID';
      else if (joined.includes('card')) info.cardType = 'Generic ID Card';
      function fallback(val) { return val ? val : 'No info found'; }
      let out = "";
      out += `Name: ${fallback(info.name)}\n`;
      out += `Date of Birth: ${fallback(info.dob)}\n`;
      out += `ID Number: ${fallback(info.id)}\n`;
      out += `Address: ${fallback(info.address)}\n`;
      out += `Sex: ${fallback(info.sex)}\n`;
      out += `Nationality: ${fallback(info.nationality)}\n`;
      out += `Issued Date: ${fallback(info.issued)}\n`;
      out += `Expiration Date: ${fallback(info.expiry)}\n`;
      return { summary: out.trim(), cardType: info.cardType };
    }

    // --- OCR handler with workerPath/langPath for Tesseract v5+ ---
    document.getElementById('idImage').addEventListener('change', function(e) {
      const img = document.getElementById('idPreview');
      const file = e.target.files[0];
      const cardTypeDisplay = document.getElementById('cardTypeDisplay');
      const extractedTextArea = document.getElementById('extractedText');
      const rawOCR = document.getElementById('rawOCR');
      const rawOCRDetails = document.getElementById('rawOCRDetails');
      cardTypeDisplay.textContent = 'Processing...';
      extractedTextArea.value = 'Extracting... Please wait.';
      rawOCRDetails.style.display = "none";
      if (file) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
        const reader = new FileReader();
        reader.onload = function(ev) {
          Tesseract.recognize(
            ev.target.result,
            'eng',
            {
              workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
              langPath: 'https://tessdata.projectnaptha.com/4.0.0_best'
            }
          ).then(({ data: { text } }) => {
            const { summary, cardType } = extractIdFields(text || '');
            extractedTextArea.value = summary;
            cardTypeDisplay.textContent = cardType;
            rawOCR.textContent = text || '';
            rawOCRDetails.style.display = "";
          }).catch(err => {
            extractedTextArea.value = 'OCR Error: ' + err.message;
            cardTypeDisplay.textContent = 'Error';
            rawOCRDetails.style.display = "none";
          });
        };
        reader.readAsDataURL(file);
      } else {
        img.style.display = 'none';
        extractedTextArea.value = "";
        cardTypeDisplay.textContent = "---";
        rawOCRDetails.style.display = "none";
      }
    });

    // Product image preview
    document.getElementById('productImage').addEventListener('change', function(e) {
      const img = document.getElementById('productPreview');
      const file = e.target.files[0];
      if (file) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
    });

    // Account number enter logic
    document.getElementById('accountNumberEnterBtn').onclick = function() {
      var acct = document.getElementById('accountNumberTop').value.trim();
      document.getElementById('productAccountNumber').textContent = acct ? acct : "---";
      if (!acct) {
        document.getElementById('userNameDisplay').textContent = "---";
        document.getElementById('productNameDisplay').textContent = "---";
        document.getElementById('productNameInput').value = "";
        document.getElementById('productDescInput').value = "";
        return;
      }
      database.ref('users').orderByChild('accountNumber').equalTo(acct).once('value', function(snapshot) {
        if (snapshot.exists()) {
          const userObj = Object.values(snapshot.val())[0];
          document.getElementById('userNameDisplay').textContent = userObj.name || "---";
          document.getElementById('productNameDisplay').textContent = userObj.product || "---";
          document.getElementById('productNameInput').value = userObj.product || "";
          document.getElementById('productDescInput').value = userObj.productDesc || "";
        } else {
          document.getElementById('userNameDisplay').textContent = "---";
          document.getElementById('productNameDisplay').textContent = "---";
          document.getElementById('productNameInput').value = "";
          document.getElementById('productDescInput').value = "";
        }
      }, function(error) {
        document.getElementById('userNameDisplay').textContent = "---";
        document.getElementById('productNameDisplay').textContent = "---";
        document.getElementById('productNameInput').value = "";
        document.getElementById('productDescInput').value = "";
      });
    };

    // Product submission logic: uploads image to Firebase Storage and saves image name/url and productDesc in the user profile
    document.getElementById('submitProductBtn').onclick = function() {
      const acctNum = document.getElementById('productAccountNumber').textContent.trim();
      const productName = document.getElementById('productNameInput').value.trim();
      const productDesc = document.getElementById('productDescInput').value.trim();
      const userName = document.getElementById('userNameDisplay').textContent.trim();
      const imageInput = document.getElementById('productImage');
      const imageFile = imageInput.files[0];

      if (!acctNum || acctNum === "---") {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Number',
          text: 'Please enter a valid account number and press Enter first.',
          confirmButtonColor: '#e53935'
        });
        return;
      }
      if (!productName) {
        Swal.fire({
          icon: 'warning',
          title: 'Missing Product Name',
          text: 'Please enter the product name.',
          confirmButtonColor: '#2196f3'
        });
        return;
      }

      database.ref('users').orderByChild('accountNumber').equalTo(acctNum).once('value', function(snapshot) {
        if (!snapshot.exists()) {
          Swal.fire({
            icon: 'error',
            title: 'Account Not Found',
            text: 'No user found with that account number.',
            confirmButtonColor: '#e53935'
          });
          return;
        }
        const userId = Object.keys(snapshot.val())[0];
        function saveProduct(imageUrl, imageName) {
          const newProductRef = database.ref('products/' + acctNum).push();
          newProductRef.set({
            productName: productName,
            productDesc: productDesc,
            imageName: imageName || "",
            imageUrl: imageUrl || "",
            userId: userId,
            userName: userName,
            addedAt: new Date().toISOString()
          }).then(() => {
            database.ref('users/' + userId).update({
              productDesc: productDesc,
              latestProductImageName: imageName || "",
              latestProductImageUrl: imageUrl || ""
            });
            Swal.fire({
              icon: 'success',
              title: 'Product Added!',
              text: 'Product has been added for this account.',
              confirmButtonColor: '#2196f3'
            });
            document.getElementById('productNameInput').value = '';
            document.getElementById('productDescInput').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productPreview').style.display = 'none';
          }).catch((error) => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: error.message,
              confirmButtonColor: '#e53935'
            });
          });
        }
        if (imageFile) {
          Swal.fire({
            title: 'Uploading...',
            text: 'Please wait while we upload your image.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          const imageName = Date.now() + "_" + imageFile.name.replace(/\s+/g, "_");
          const storageRef = storage.ref('product_images/' + acctNum + '/' + imageName);
          storageRef.put(imageFile).then(snapshot => {
            snapshot.ref.getDownloadURL().then(imageUrl => {
              Swal.close();
              saveProduct(imageUrl, imageName);
            });
          }).catch(err => {
            Swal.fire({
              icon: 'error',
              title: 'Image Upload Failed',
              text: err.message,
              confirmButtonColor: '#e53935'
            });
          });
        } else {
          saveProduct();
        }
      });
    };

    // Verification button with loading spinner
    document.getElementById('verifyBtn').onclick = function() {
      var acct = document.getElementById('accountNumberTop').value.trim();
      if (!acct) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Number',
          text: 'Please enter the account number in the Product Panel first!',
          confirmButtonColor: '#e53935'
        });
        return;
      }
      Swal.fire({
        title: 'Verifying...',
        text: 'Please wait while we verify the account.',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      database.ref('users').orderByChild('accountNumber').equalTo(acct).once('value', function(snapshot) {
        if (snapshot.exists()) {
          const userId = Object.keys(snapshot.val())[0];
          database.ref('users/' + userId).update({ verified: true })
            .then(() => {
              Swal.fire({
                icon: 'success',
                title: 'Account Verified!',
                text: 'The user account has been marked as verified.',
                confirmButtonColor: '#2196f3'
              });
            })
            .catch((error) => {
              Swal.fire({
                icon: 'error',
                title: 'Verification Failed',
                text: error.message,
                confirmButtonColor: '#e53935'
              });
            });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Account Not Found',
            text: 'No user found for this account number.',
            confirmButtonColor: '#e53935'
          });
        }
      }, function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message,
          confirmButtonColor: '#e53935'
        });
      });
    };
  </script>
</body>
</html>