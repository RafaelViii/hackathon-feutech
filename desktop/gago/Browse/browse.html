<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Browse - Scale Up</title>
  <link rel="stylesheet" href="index.css">
  <style>
   body {
      margin: 0;
      background: #f5f6fa;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #111;
    }
    .browse-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      padding: 24px 36px 16px 36px;
      border-bottom: 1px solid #e8eaf0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .search-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f1f7;
      border-radius: 8px;
      padding: 10px 18px;
      flex: 1;
      max-width: 480px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin: 0 auto 0 0;
    }
    .search-bar input[type="text"] {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1.15rem;
      font-weight: 600;
      flex: 1;
      padding: 6px 0;
      color: #222;
    }
    .search-icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
    }
    .search-icon-btn svg {
      width: 22px;
      height: 22px;
    }
    h1 {
      font-size: 2.4rem;
      font-weight: 800;
      color: #111;
      margin: 36px 0 32px 0;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .category-section {
      margin-bottom: 54px;
    }
    .category-title {
      font-size: 2rem;
      font-weight: 800;
      color: #111;
      margin: 18px 0 10px 3vw;
      text-align: left;
      letter-spacing: 0.01em;
      line-height: 1.2;
    }
    .category-carousel {
      overflow-x: auto;
      display: flex;
      flex-direction: row;
      gap: 28px;
      padding: 20px 22px 8px 22px;
      border-radius: 16px;
      border: 1.5px solid #d1d5db;
      background: #fff;
      box-shadow: 0 4px 18px 0 rgba(60,60,60,0.06);
      margin: 0 2vw;
    }
    .product-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(30,32,42,0.07);
      min-width: 210px;
      max-width: 250px;
      flex: 0 0 210px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-height: 160px;
      scroll-snap-align: start;
      border: 1px solid #e5e7eb;
      padding: 16px 18px;
    }
    .product-card img {
      width: 74px;
      height: 74px;
      object-fit: cover;
      border-radius: 7px;
      margin-bottom: 13px;
      background: #f5f6fa;
      border: 1px solid #e5e7eb;
      display: block;
    }
    .product-title {
      font-size: 1.09rem;
      font-weight: 700;
      margin-bottom: 5px;
      color: #222;
      text-align: left;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-desc {
      font-size: 0.98rem;
      color: #444;
      text-align: left;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    @media (max-width: 700px) {
      .browse-header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        padding: 16px 10px 10px 10px;
      }
      h1 { font-size: 1.45rem; }
      .category-title { font-size: 1.13rem; }
      .category-carousel { gap: 12px; padding: 10px 4vw 6px 4vw; }
      .product-card { min-width: 130px; max-width: 88vw; padding: 9px 4vw; }
    }
  </style>
</head>
<body>
<header class="browse-header">
  <form class="search-bar" id="browseSearchForm" autocomplete="off" onsubmit="return false;">
    <input type="text" id="searchInput" placeholder="Search businesses, products, or keywords..." />
    <button class="search-icon-btn" id="searchBtn" aria-label="Search">
      <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
        <circle cx="10" cy="10" r="7" stroke="#222" stroke-width="2"/>
        <line x1="15.293" y1="15.707" x2="20" y2="20" stroke="#222" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </form>
</header>
<h1>Browse Categories</h1>
<div id="all-categories"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<!-- ...your usual HTML and CSS... -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDZsj-cL_T_BuLtAz5bkqsw-edZXnumwe0",
  authDomain: "iot-web-58054.firebaseapp.com",
  databaseURL: "https://iot-web-58054-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "iot-web-58054",
  storageBucket: "iot-web-58054.appspot.com",
  messagingSenderId: "949884902967",
  appId: "1:949884902967:web:6e7f78c7cd0fa1484629b2",
  measurementId: "G-5C79490N66"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Build a fast lookup: { 'uid|productName': imageUrl }
async function getProductImagesMap() {
  const snap = await db.ref("products").once("value");
  const map = {};
  const obj = snap.val() || {};
  Object.entries(obj).forEach(([userId, prodGroup]) => {
    if (typeof prodGroup === 'object') {
      Object.entries(prodGroup).forEach(([prodId, prod]) => {
        // Only add if we have both productName and imageUrl
        if ((prod.productName || prod.name) && prod.imageUrl) {
          // Support both productName and name fields
          map[`${userId}|${prod.productName || prod.name}`] = prod.imageUrl;
        }
      });
    }
  });
  return map;
}

// Fetch all categories/subcategories/products
async function getAllCategoryProducts() {
  return db.ref("categories").once("value").then(snapshot => snapshot.val() || {});
}

async function renderCategoriesWithImages(categoriesData, productImagesMap, searchTerm) {
  const container = document.getElementById('all-categories');
  container.innerHTML = '';
  let anyShown = false;

  // Loop over main categories
  Object.entries(categoriesData).forEach(([mainCat, subcats]) => {
    let catHtml = '';

    // Loop over subcategories
    Object.entries(subcats || {}).forEach(([subcat, products]) => {
      let filteredProducts = [];
      Object.values(products || {}).forEach(prod => {
        const businessName = prod.businessName || "";
        const product = prod.product || "";
        if (
          !searchTerm ||
          businessName.toLowerCase().includes(searchTerm) ||
          product.toLowerCase().includes(searchTerm)
        ) {
          filteredProducts.push(prod);
        }
      });

      if (filteredProducts.length > 0) {
        anyShown = true;
        catHtml += `<div style="margin-top:1.5em;">
          <div class="category-title" style="font-size:1.25rem;margin-bottom:.4em;">${subcat}</div>
          <div class="category-carousel">`;
        filteredProducts.forEach(prod => {
          let imgSrc = 'https://via.placeholder.com/80';
          if (prod.uid && prod.product) {
            const foundUrl = productImagesMap[`${prod.uid}|${prod.product}`];
            if (foundUrl) imgSrc = foundUrl;
          }
          catHtml += `
            <div class="product-card">
              <img src="${imgSrc}" alt="${prod.businessName || prod.product}">
              <div class="product-title">${prod.businessName || prod.product || ''}</div>
              <div class="product-desc">${prod.product || ''}</div>
              <div style="color:#888;font-size:0.98em;margin-top:3px;">${prod.tagline || ''}</div>
            </div>
          `;
        });
        catHtml += `</div></div>`;
      }
    });

    if (catHtml) {
      container.insertAdjacentHTML('beforeend', `
        <section class="category-section">
          <div class="category-title" style="font-size:2rem;">${mainCat}</div>
          ${catHtml}
        </section>
      `);
    }
  });

  if (!anyShown) {
    container.innerHTML = `<div style="text-align:center;color:#aaa;font-style:italic;margin:50px 0;">No products found.</div>`;
  }
}

// Main load and search logic
async function loadAllCategories(search) {
  const [categoriesData, productImagesMap] = await Promise.all([
    getAllCategoryProducts(),
    getProductImagesMap()
  ]);
  const searchTerm = (search || '').trim().toLowerCase();
  renderCategoriesWithImages(categoriesData, productImagesMap, searchTerm);
}

// Search event
document.getElementById('searchBtn').onclick = function() {
  const val = document.getElementById('searchInput').value;
  loadAllCategories(val);
};
document.getElementById('searchInput').addEventListener("keypress", function(e) {
  if (e.key === "Enter") document.getElementById('searchBtn').onclick();
});

// Initial load
window.onload = function() {
  loadAllCategories('');
};
</script>
</body>
</html>