<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enroll a Fingerprint</title>
  <style>
    :root {
      --background: #87CEEB;
      --enroll-btn: linear-gradient(135deg, #21e6f3 0%, #2196f3 60%, #005fa3 100%);
      --enroll-btn-hover: linear-gradient(135deg, #a3e7ff 0%, #2196f3 80%, #005fa3 100%);
      --backbuttons: linear-gradient(135deg, #87ceeb 0%, #2196f3 60%, #005fa3 100%);
      --container-bg: #f5fbffcc;
      --instructions-bg: #fff;
      --instructions-border: #2196f3;
    }

    body {
      background: var(--background);
      font-family: 'Lilita One', 'IM FELL Great Primer', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 480px;
      margin: 7vh auto 0 auto;
      background: var(--container-bg);
      border-radius: 16px;
      box-shadow: 0 2px 24px #2196f355;
      padding: 2.5em 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-bottom: 1.2em;
      font-size: 2.1em;
      color: #005fa3;
      letter-spacing: 1px;
    }

    #instructions {
      background: var(--instructions-bg);
      border: 2px solid var(--instructions-border);
      border-radius: 10px;
      padding: 1.2em 1em;
      color: #005fa3;
      font-size: 1.25em;
      text-align: center;
      margin-bottom: 2em;
      min-width: 230px;
      min-height: 3em;
      box-sizing: border-box;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 10px #2196f322;
    }

    #startEnroll, #backBtn {
      display: block;
      width: 90%;
      max-width: 350px;
      margin: 0.5em auto;
      padding: 0.9em 0;
      font-size: 1.15em;
      border: none;
      border-radius: 30px;
      background: var(--enroll-btn);
      color: #fff;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 14px #2196f333;
      transition: background 0.2s, box-shadow 0.2s;
    }

    #startEnroll:hover, #backBtn:hover {
      background: var(--enroll-btn-hover);
      box-shadow: 0 4px 22px #2196f355;
    }

    #backBtn {
      background: var(--backbuttons);
      margin-top: 0.7em;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 98vw;
        padding: 1.2em 0.5em;
      }
      h2 {
        font-size: 1.4em;
      }
      #instructions {
        font-size: 1em;
        padding: 0.7em 0.5em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Enroll a Fingerprint</h2>
    <div id="instructions">Loading instructions...</div>
    <button id="startEnroll">Start Enrollment</button>
    <button id="backBtn">Back</button>
  </div>
  <script>
const ESP32_IP = "192.168.100.204";

// Fetch enrollment instructions from ESP32 and display at page load
function loadInstructions() {
  document.getElementById("instructions").innerText = "Loading instructions...";
  fetch(`http://${ESP32_IP}/enroll_instructions`)
    .then(res => res.json())
    .then(obj => {
      document.getElementById("instructions").innerText = obj.instructions || "Press Start Enrollment to use the first available slot.";
    })
    .catch(() => {
      document.getElementById("instructions").innerText = "Press Start Enrollment to use the first available slot.";
    });
}

document.getElementById("startEnroll").addEventListener("click", function() {
  document.getElementById("instructions").innerText = "Checking available slots...";
  fetch(`http://${ESP32_IP}/free_slots`)
    .then(res => res.json().then(data => ({status: res.status, body: data})))
    .then(({status, body}) => {
      if (status !== 200) {
        document.getElementById("instructions").innerText =
          `Error (${body.error_code || status}): ${body.error || "Unknown error"}`;
        return;
      }
      if (body.free && body.free.length > 0) {
        const id = body.free[0];
        document.getElementById("instructions").innerText = `Enrolling in slot ${id}...\n\n1. Place your finger on the sensor when prompted.\n2. Wait for scan, then remove your finger when asked.\n3. Place the same finger again as prompted.\n4. Wait for enrollment result message.\n\nEnrolling now...`;
        fetch(`http://${ESP32_IP}/enroll?id=${id}`, { method: "POST" })
          .then(response => response.json().then(data => ({status: response.status, body: data})))
          .then(({status, body}) => {
            if (status !== 200) {
              document.getElementById("instructions").innerText =
                `Error (${body.error_code || status}): ${body.error || "Unknown error"}`;
              return;
            }
            document.getElementById("instructions").innerText = body.result || body.error || "Unknown response";
          })
          .catch(err => {
            document.getElementById("instructions").innerText = "Could not contact device.";
          });
      } else {
        document.getElementById("instructions").innerText = "No available slots!";
      }
    })
    .catch(err => {
      document.getElementById("instructions").innerText = "Could not check slots.";
    });
});
document.getElementById("backBtn").onclick = () => window.location.href = "screen2.html";

// Load instructions at page load
loadInstructions();
  </script>
</body>
</html>